% Copyright (c) 2012 Taylor Hutt, Logic Magicians Software
%
% This program is free software: you can redistribute it and/or
% modify it under the terms of the GNU General Public License as
% published by the Free Software Foundation, either version 3 of the
% License, or (at your option) any later version.
%
% This program is distributed in the hope that it will be useful, but
% WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
% General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
%
\chapter{Variable Reference}\label{chap:variables}

The \lmsbw system uses associative arrays as a kind of record
structure to facilitate a programming interface that uses few
variables in a uniform manner.

This chapter provides a reference for the variables that are used
internally by \lmsbw, and that provide the low-level interface used to
declare and define components.

\begin{center}\framebox{\begin{minipage}{.9\linewidth}\textbf{NOTE}

    Be aware that spaces in \gnumake function arguments are
  significant.  The examples shown in this chapter have been formatted
  to be easily readable in a printed document; it is frequently best
  of have the entire function call on a single line in the source
  file, or to fastidiously use \texttt{\$(strip)} on function
  arguments.\end{minipage}}\end{center}

\section{\lmsbwconfiguration}\label{variables:lmsbw-configuration}

This variable is the nexus of all global configuration for a porject.
It must be initialized by the master configuration file
(\xref{lmsbw:configuration}, \xref{wrap:master-configuration}), or
\lmsbw will fail with an error message indicating that the
configuration is bad.

It is implemented as an associative array, and is readily extensible
by simply adding new \emph{key} / \emph{value} pairs.

Its keys and values must not be changed after the initial load of the
master configuration file.

Each key covers a global configuration option that will affect the
entire project.  The following sections describe the valid keys and
their allowed values.


\subsection{\texttt{component-build-support}}\label{variables:component-build-support}

To be more modular and easily extensible, \lmsbw dynamically loads
support for the \texttt{kind} (\xref{variables:kind}) of components
that are required based on the value of this variable.

By including a component \texttt{kind} in this variable, the ability
declare and build such components will be enabled.  If a component
\texttt{kind} is not enabled, it will not be possible to build
components of that type.

If no component kinds are specified in the configuration, \lmsbw will
exit with an error.

\subsection{\texttt{load-configuration-function}}\label{variables:load-configuration-function}

This key must be the name of a \gnumake function which will load the
component configurations which comprise the project.

\begin{figure}
\hrulefill
\begin{verbatim}
vv:=$(call set,LMSBW_configuration, \
      load-configuration-function,  \
      load_configuration)
\end{verbatim}
\hrulefill
\caption{Setting \texttt{load-configuration-function}}\label{variables:set-load-configuration}
\end{figure}

In the figure~\tabref{variables:set-load-configuration}, the
user-supplied function called \texttt{load\_configuration} will be
invoked to load the component configurations.

\subsubsection{Load Configuration Signature}

The function name assigned to \texttt{load-configuration-function} has
the signature shown below:

\begin{tabularx}{\linewidth}{ll|X}
  \multicolumn{3}{c}{\textbf{Arguments}} \\ \hline
  1 & pathname &   The only  argument to this function is the full pathname of the
  master configuration file provided to \lmsbw. \\
\end{tabularx}


Upon successful exit, the named function must have done the following:

\begin{itemize}
\item Create list of loaded components
  (\xref{variables:lmsbw-components})

\item Configure individual components

  For each component contained in the \lmsbwcomponents variable, there
  must be an associative array named \lmsbwcomponent{component}.
  See \xref{chap:wrapping} for details on declaring components.

\end{itemize}


\section{\texttt{LMSBW\_components}}\label{variables:lmsbw-components}

After the \texttt{load-configuration-function} variable
(\xref{variables:load-configuration-function}) has completed
initializing the project configuration, this variable must contain list
of configured components.

The variable is internally managed when using the official APIs for
declaring components -- it should not be necessary to change this
variable.

The list must adhere to the following rules:

\begin{itemize}
\item Space separated.
\item No duplicates.
\item Each item must have a corresponding \lmsbwcomponent{component}
  associative array.
\end{itemize}

\lmsbw will use this list of components to generate the rules which
will be used to build the project.

% To verify that this documentation is complete, you must find all
% component associative array keys.  This is done by looking for
% the function which sets component keys -- lmsbw_scf -- in the
% 'wrapper' directory.
\section{\lmsbwcomponent{component}}\label{variables:lmsbw-component-component}

Each component named in \lmsbwcomponents must have a corresponding
associative array which describes all the attributes needed to
correctly build it.  Be aware that the allowed attributes will vary
based on the \texttt{kind} (\xref{variables:kind}) of the component.

These variables are internally managed when using \lmsbw.

Once key:value pairs are set they should not be changed.

The following sections describe the various kinds of components, their
allowable associative keys and values.

\section{Source Components}

Source components are declared to \lmsbw using
\texttt{declare\_source\_component}
(\xref{api:declare-source-component}).

The keys described in the following sections are present in variables
described in \xref{variables:lmsbw-component-component}.

Note that the majority of the keys described in the following sections
can be seen by using the \texttt{report} verb
(\xref{usinglmsbw:report}).


\subsection{\lmsbwcomponentfield{api}}\label{variables:api}

This is a list of directories that contain the public API of the
component.  The directories must be installed into the \destdir by the
component's build process during the installation phase of the build.

All directly dependent components will have their build process
invoked if any files change in the named directories.

This variable should be set to the directories that contain exported
header files, static libraries, icons, and other build output that
affects the building of other components.

It is not necessary to set this key if there is no exported API.

\apiref{api:component-attribute-api}

\subsection{\lmsbwcomponentfield{build-directory}}\label{variables:build-directory}

This key is used internally; it contains the absolute pathname of the
directory in which the build will be performed.

This key must not be used by clients of \lmsbw.

\apiref{api:declare-source-component}

\subsection{\lmsbwcomponentfield{build-log}}\label{variables:build-log}

This key is used internally; it contains the absolute pathname of the
file containing the console output of the component's build process.

To view the log for a component, use the \texttt{log} verb, like so:

\begin{verbatim}
lmbw log.hello-world
\end{verbatim}

This key must not be used by clients of \lmsbw.

\apiref{api:declare-source-component}

\subsection{\lmsbwcomponentfield{build-root-directory}}\label{variables:build-root-directory}

This key holds the root directory where all build-related output is
placed for the associated component.

This key must not be used by clients of \lmsbw.

\apiref{api:declare-source-component}

\subsection{\lmsbwcomponentfield{build-target}}\label{variables:build-target}

This key holds the list of targets used when invoking the component's
\makefile to build.

If not specified, the component's build system will invoked with no
target when building; this will cause the default target of the
component's \makefile to be built.

Compare to \xref{variables:install-target}.

\apiref{api:component-attribute-build-target}

\subsection{\lmsbwcomponentfield{cflags}}\label{variables:cflags}

This key holds a list of values which will be assigned to the
\texttt{LMSBW\_C\_CFLAGS} variable before the component's \makefile is
invoked.  The invoked \makefile should add the value of
\texttt{LMSBW\_C\_CFLAGS} to \texttt{CFLAGS}\footnote{See
  \xref{api:cflags} for the reason why this indirect method is used.}.

The value of this key is also used to help determine the build
directory name for each component.  Changing value of
\lmsbwcomponentfield{cflags} for a component will change the build
output directory. The purpose of this several fold:

\begin{itemize}
\item \texttt{CFLAGS} changes incorporated into build

  Build processes infrequently have correct dependencies to do a
  proper build when compiler options change.  Assigning a build
  directory based partially on the compiler options guarantees that
  such changes are correctly reflected in the build; changing
  \texttt{CFLAGS} results in a different build directory.

\item Incremental builds

  Changing the options will result in the build output directory
  changing, but changing them back to their original value will also
  restore the old build directory; incremental builds between compiler
  options changes remain fast.

\item Shared build output

  A component compiled with the same global options, regardless if it
  is for a different SKU, will share the same build output.
\end{itemize}

It is recommended that all compiler options be set in the component
configuration file rather than in the component \makefile.

\apiref{api:cflags}

\subsection{\lmsbwcomponentfield{component}}\label{variables:component}

This key contains the name of the component.

\apiref{api:declare-source-component}

\subsection{\lmsbwcomponentfield{configuration-file}}\label{variables:configuration-file}

This key is the absolute pathname of the component configuration file
that was used to declare the component.

Changes to the configuration file will result in the component's build
process being invoked.

Component configuration files can contain \makefile rules that will
override the defaults for building
(\xref{overriding:overriding-build}) and installing
(\xref{overriding:overriding-install}) the component.

\apiref{api:declare-source-component}

\subsection{\lmsbwcomponentfield{description}}\label{variables:description}

This key holds the description of the component.

\apiref{api:declare-source-component}

\subsection{\lmsbwcomponentfield{destdir-directory}}\label{variables:destdir-directory}

This key holds the absolute path of the \destdir directory; after
building, the component's public files must be \emph{installed} to this
intermediate install directory when the \texttt{install} target of the
component's \makefile is invoked.

\lmsbw will copy the files from \destdir to the shared install directory.

To install files, append the actual install pathname to \destdir.  For
example, if the file should end up in \texttt{/usr/include}, one way
to install it would be:

\begin{verbatim}
cp include-file.h $(DESTDIR)/usr/include
\end{verbatim}

\apiref{api:declare-source-component}

\subsection{\lmsbwcomponentfield{hash}}\label{variables:hash}

This key contains a hash that is used to create directory names for
build output.  The attributes of the component which dictate a
different build directory (toolchain, compiler flags, etc.) particpate
in this hash.

\subsection{\lmsbwcomponentfield{install-directory}}\label{variables:install-directory}

This key holds the absolute path of the shared install directory.
After building, \lmsbw will invoke the component's build process with
the \emph{install} target (\xref{variables:install-target}), and this
target must place files to be installed into the \destdir directory.

Upon successful completion of component installation, \lmsbw will copy
the files from the \destdir to the shared install directory.

This key must not be used by clients of \lmsbw.

\apiref{api:declare-source-component}

\subsection{\lmsbwcomponentfield{install-target}}\label{variables:install-target}

This key holds the component's \makefile target that is used to
\emph{install} the component into the \destdir.

If not specified, the component's build system will invoked with
\texttt{install} as the target when processing the \emph{install}
phase of the build.

Compare to \xref{variables:build-target}.

\apiref{api:component-attribute-install-target}

\subsection{\lmsbwcomponentfield{kind}}\label{variables:kind}

This key represents the \emph{kind} of the component.

The supported values are as follows:

\begin{itemize}
\item source
\end{itemize}

If adding a new type of component to \lmsbw, add support for new
values of this key.

This value is used in the creation of function names, and these
\texttt{kind}-based function names are used to process -- generate
rules, produce reports, etc. -- components of that specific
\emph{kind}.

\lmsbw will check that functions used in this manner exist before
attempting to invoke them\footnote{Invoking a function name which does
  not exist in \gnumake produces no error, and does nothing.  That's
  ok; \lmsbw takes advantage of that with component declaration
  functions which are processed in the main \makefile and ignored in
  \texttt{component.makefile}.}.  When implementing a new \emph{kind}
of component, failure to create all the necessary functions will cause
\lmsbw will produce an error and stop.

See \xref{variables:component-build-support} for information on
loading support for a particular \emph{kind} of component in a
project.

\apiref{api:declare-source-component}

\subsection{\lmsbwcomponentfield{no-parallel}}\label{variables:no-parallel}

This key, when set, causes the recursive make for the associated
component to \emph{never} allow parallel builds; it directly sets the
\gnumake parallel option to \texttt{-j 1}.

This key is normally only needed to address build issues -- caused by
bad dependencies.

\apiref{api:component-attribute-no-parallel-build}

\subsection{\lmsbwcomponentfield{prerequisite}}\label{variables:prerequisite}

This key holds a list of components declared to be prerequisites of
the associated component.  All components contained in this list will
be successfully built and installed before the associated component is
even attempted to be built.

An empty value means that there are no prerequisites.

\apiref{api:declare-source-component}

\subsection{\lmsbwcomponentfield{reason}}\label{variables:reason}

This key holds the \emph{reason} this component is being built.

Reason can be one of two values:

  \begin{enumerate}
  \item \texttt{build}

    The component is used in other parts of the build process and is
    not intended to be part of the delivered product.

    Components declared with this \emph{reason} are always built with
    the native toolchain present on the host; this ensures that the
    program will actually run on the machine which is performing the
    build.

  \item \texttt{image}

    The component is built as part of the overall project, and it is
    intended to be delivered with the shipping product.

    Components declared with this \emph{reason} will always use the
    component-defined, globally-defined or host toolchain to build.

    If the component does not declare a specific toolchain, the global
    toolchain declaration is used.  If there is no global toolchain
    specified, then the toolchain installed on the host will be used
    to build the component.

  \end{enumerate}

  \lmsbw maintains separate component install \& build directories for
  each \texttt{reason}.  The impetus for this separation is cross
  compilation: \texttt{build} components are built with the native
  toolchain installed on the host computer, and the file format may be
  different than those of type \texttt{image}.  This separation also
  reduces the risk of accidentally installing build-only components
  into a deliverable product.

  See \xref{wrap:using-build-components} for information on using
  \texttt{build}-reasoned components.

\apiref{api:declare-source-component}

\subsection{\lmsbwcomponentfield{source-directory}}\label{variables:source-directory}

This key contains the absolute pathname of the source directory for
the component.

This key must not be used by clients of \lmsbw.

\apiref{api:declare-source-component}

\subsection{\lmsbwcomponentfield{source-mtree-manifest}}\label{variables:source-mtree-manifest}

This key holds the absolute pathname of the file which holds the
\mtree manifest for the source directory.

This value should not be used by a client of \lmsbw.

\apiref{api:declare-source-component}

\subsection{\lmsbwcomponentfield{toolchain}}\label{variables:toolchain}

This is the name of the toolchain that will be used to build the
component.  If it is not specified at the component level, and the
component is not a \texttt{build} component (\xref{variables:reason}),
the globally specified toolchain is used.  If no global toolchain is
specified, the host toolchain will be used.

The global toolchain setting is never used for \texttt{build}
components.  If the toolchain is not specified at the component level
for a \texttt{build} component, then the host toolchain will be used.

\apiref{api:toolchain}
